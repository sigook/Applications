trigger:
  - main
  - master
  - dev

variables:
  isMain: $[in(variables['Build.SourceBranch'], 'refs/heads/main','refs/heads/master','main','master')]
  isDev: $[in(variables['Build.SourceBranch'], 'refs/heads/dev','refs/heads/development','dev','development')]

pool:
  vmImage: "ubuntu-22.04"

stages:
  - stage: Release
    jobs:
      - job: BuildPublish
        steps:
          - script: |
              echo "Calculating TAG based on branch $(Build.SourceBranchName)â€¦"
                if [ "$(isDev)" = True ]; then
                  tag=latest_staging
                else
                  tag=latest_production
                fi
                echo "##vso[task.setvariable variable=tag]$tag"
                echo "##vso[task.setvariable variable=tag;isOutput=true]$tag"
                echo "TAG calculated: $tag"
            name: SetTag
          - task: Docker@2
            displayName: Docker build
            inputs:
              containerRegistry: "acrServiceConnectionSigook"
              repository: "identityserver"
              command: "build"
              arguments: "--build-arg PAT=$(PatSigookPackages)"
              Dockerfile: "Covenant.IdentityServer/Dockerfile"
              tags: $(tag)
          - task: Docker@2
            displayName: Docker push
            inputs:
              containerRegistry: "acrServiceConnectionSigook"
              repository: "identityserver"
              command: "push"
              tags: $(tag)
      - job: Deploy
        dependsOn: BuildPublish
        variables:
          imageTag: $[ dependencies.BuildPublish.outputs['SetTag.tag'] ]
        steps:
          - script: |
              if [ "$(isDev)" = True ]; then
                azureAppName="sigook-accounts-staging"
              else
                azureAppName="sigook-accounts"
              fi
              echo "##vso[task.setvariable variable=azureAppName]$azureAppName"
              echo "Deploying to $azureAppName"
              echo "Using tag: $(imageTag)"
            displayName: Read Environment
          - task: AzureWebAppContainer@1
            inputs:
              azureSubscription: "SigookPipelines"
              appName: $(azureAppName)
              containers: sigook.azurecr.io/identityserver:$(imageTag)
              appSettings: "-CVN_VERSION $(Build.BuildId)"
