# Azure Pipeline for SigookApp (Flutter Mobile Application)
# Builds Android APK/AAB and iOS IPA for staging and production environments

name: SigookApp-$(Date:yyyyMMdd)$(Rev:.r)

# Only trigger when SigookApp files change
trigger:
  branches:
    include:
      - main
      - dev
      - SigookApp
  paths:
    include:
      - SigookApp/**
      - .azure-pipelines/sigookapp-pipeline.yml
      - .azure-pipelines/templates/flutter-setup.yml
    exclude:
      - SigookApp/README.md
      - SigookApp/docs/**
      - SigookApp/**/*.md

# PR trigger - only validate PRs to dev (not to main)
# PRs to main are trusted since dev is the quality gate
pr:
  branches:
    include:
      - dev
  paths:
    include:
      - SigookApp/**
      - .azure-pipelines/sigookapp-pipeline.yml
    exclude:
      - SigookApp/README.md
      - SigookApp/docs/**

# Environment detection variables
variables:
  workingDirectory: '$(System.DefaultWorkingDirectory)/SigookApp'
  isMain: $[in(variables['Build.SourceBranch'], 'refs/heads/main','main')]
  isDev: $[in(variables['Build.SourceBranch'], 'refs/heads/dev','refs/heads/development','refs/heads/SigookApp','dev','development','SigookApp')]
  isPR: $[eq(variables['Build.Reason'], 'PullRequest')]
  flutterVersion: 'stable'

stages:
  # ============================================
  # Stage 1: Validate and Test
  # ============================================
  - stage: Validate_and_Test
    displayName: 'Validate & Test'
    pool:
      vmImage: 'ubuntu-latest'
    jobs:
      - job: Flutter_Test
        displayName: 'Flutter Analyze & Test'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          - task: Bash@3
            displayName: 'Display Build Information'
            inputs:
              targetType: 'inline'
              script: |
                echo "========================================"
                echo "SigookApp Pipeline - Validate & Test"
                echo "========================================"
                echo "Build Number: $(Build.BuildNumber)"
                echo "Source Branch: $(Build.SourceBranch)"
                echo "Build Reason: $(Build.Reason)"
                echo "Working Directory: $(workingDirectory)"
                echo "========================================"

          # Install Flutter SDK
          - task: FlutterInstall@0
            displayName: 'Install Flutter SDK'
            inputs:
              mode: 'auto'
              channel: '$(flutterVersion)'
              version: 'latest'

          - script: |
              flutter --version
              flutter doctor -v
            displayName: 'Flutter Doctor'

          # Get dependencies
          - script: |
              cd $(workingDirectory)
              flutter pub get
            displayName: 'Flutter Pub Get'

          # Run code generation
          - script: |
              cd $(workingDirectory)
              echo "Running build_runner..."
              flutter pub run build_runner build --delete-conflicting-outputs
              echo "✅ Code generation completed"
            displayName: 'Run Build Runner'

          # Analyze code
          - script: |
              cd $(workingDirectory)
              echo "Running flutter analyze..."
              flutter analyze --no-fatal-infos
              echo "✅ Code analysis passed"
            displayName: 'Flutter Analyze'

          # Run tests
          - script: |
              cd $(workingDirectory)
              echo "Running flutter test..."
              flutter test --coverage --machine > test-results.json || true
              echo "✅ Tests completed"
            displayName: 'Flutter Test'

          # Publish test results (if test output exists)
          - task: Bash@3
            displayName: 'Test Summary'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                if [ -f "test-results.json" ]; then
                  echo "Test results generated"
                  cat test-results.json | head -100
                else
                  echo "No test results file found"
                fi
                echo ""
                echo "✅ Validation stage completed!"

  # ============================================
  # Stage 2: Build Android APK (Staging)
  # ============================================
  - stage: Build_Android_Staging
    displayName: 'Build Android (Staging)'
    dependsOn: Validate_and_Test
    condition: and(succeeded(), eq(variables['isDev'], true), ne(variables['isPR'], true))
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      - group: SigookApp-Staging  # Variable group with env vars
      - group: SigookApp-Android-Signing  # Keystore credentials
    jobs:
      - job: Build_APK_Staging
        displayName: 'Build Staging APK'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          # Download keystore from secure files
          - task: DownloadSecureFile@1
            name: androidKeystore
            displayName: 'Download Android Keystore'
            inputs:
              secureFile: 'sigook-release.keystore'

          # Copy keystore to android directory
          - script: |
              cp $(androidKeystore.secureFilePath) $(workingDirectory)/android/app/sigook-release.keystore
              echo "✅ Keystore copied to android/app/"
            displayName: 'Setup Keystore'

          # Install Flutter SDK
          - task: FlutterInstall@0
            displayName: 'Install Flutter SDK'
            inputs:
              mode: 'auto'
              channel: '$(flutterVersion)'
              version: 'latest'

          # Get dependencies
          - script: |
              cd $(workingDirectory)
              flutter pub get
            displayName: 'Flutter Pub Get'

          # Run code generation
          - script: |
              cd $(workingDirectory)
              flutter pub run build_runner build --delete-conflicting-outputs
            displayName: 'Run Build Runner'

          # Build staging APK with environment variables via --dart-define
          - script: |
              cd $(workingDirectory)
              echo "Building staging APK..."
              flutter build apk \
                --flavor staging \
                -t lib/main_staging.dart \
                --release \
                --dart-define=ENVIRONMENT=staging \
                --dart-define=AUTH_AUTHORITY=$(AUTH_AUTHORITY) \
                --dart-define=API_BASE_URL=$(API_BASE_URL) \
                --dart-define=CLIENT_ID=$(CLIENT_ID) \
                --dart-define=REDIRECT_URI=$(REDIRECT_URI) \
                --dart-define=POST_LOGOUT_REDIRECT_URI=$(POST_LOGOUT_REDIRECT_URI) \
                --dart-define=SCOPES=$(SCOPES) \
                --dart-define=APP_NAME=$(APP_NAME)
              echo "✅ Staging APK built successfully"
            displayName: 'Build Staging APK'
            env:
              KEYSTORE_PASSWORD: $(KEYSTORE_PASSWORD)
              KEY_PASSWORD: $(KEY_PASSWORD)
              KEY_ALIAS: $(KEY_ALIAS)

          # Copy APK to staging directory
          - task: Bash@3
            displayName: 'Prepare Artifacts'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                mkdir -p $(Build.ArtifactStagingDirectory)/android
                
                # Find and copy APK
                APK_PATH=$(find build/app/outputs/flutter-apk -name "*staging*.apk" | head -1)
                if [ -n "$APK_PATH" ]; then
                  cp "$APK_PATH" $(Build.ArtifactStagingDirectory)/android/sigook-staging-$(Build.BuildId).apk
                  echo "✅ APK copied: sigook-staging-$(Build.BuildId).apk"
                  ls -la $(Build.ArtifactStagingDirectory)/android/
                else
                  echo "❌ APK not found!"
                  find build -name "*.apk" -ls
                  exit 1
                fi

          # Publish APK artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Staging APK'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/android'
              ArtifactName: 'sigookapp-android-staging'
              publishLocation: 'Container'

          - task: Bash@3
            displayName: 'Build Summary'
            inputs:
              targetType: 'inline'
              script: |
                echo ""
                echo "========================================"
                echo "✅ Staging Android Build Complete!"
                echo "========================================"
                echo "Artifact: sigookapp-android-staging"
                echo "APK: sigook-staging-$(Build.BuildId).apk"
                echo "Build ID: $(Build.BuildId)"
                echo "========================================"

  # ============================================
  # Stage 3: Build Android APK (Production)
  # ============================================
  - stage: Build_Android_Production
    displayName: 'Build Android (Production)'
    dependsOn: Validate_and_Test
    condition: and(succeeded(), eq(variables['isMain'], true), ne(variables['isPR'], true))
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      - group: SigookApp-Production  # Variable group with env vars
      - group: SigookApp-Android-Signing  # Keystore credentials
    jobs:
      - job: Build_APK_Production
        displayName: 'Build Production APK'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'

          # Download keystore from secure files
          - task: DownloadSecureFile@1
            name: androidKeystore
            displayName: 'Download Android Keystore'
            inputs:
              secureFile: 'sigook-release.keystore'

          # Copy keystore to android directory
          - script: |
              cp $(androidKeystore.secureFilePath) $(workingDirectory)/android/app/sigook-release.keystore
              echo "✅ Keystore copied to android/app/"
            displayName: 'Setup Keystore'

          # Install Flutter SDK
          - task: FlutterInstall@0
            displayName: 'Install Flutter SDK'
            inputs:
              mode: 'auto'
              channel: '$(flutterVersion)'
              version: 'latest'

          # Get dependencies
          - script: |
              cd $(workingDirectory)
              flutter pub get
            displayName: 'Flutter Pub Get'

          # Run code generation
          - script: |
              cd $(workingDirectory)
              flutter pub run build_runner build --delete-conflicting-outputs
            displayName: 'Run Build Runner'

          # Build production APK with environment variables via --dart-define
          - script: |
              cd $(workingDirectory)
              echo "Building production APK..."
              flutter build apk \
                --flavor production \
                -t lib/main_production.dart \
                --release \
                --dart-define=ENVIRONMENT=production \
                --dart-define=AUTH_AUTHORITY=$(AUTH_AUTHORITY) \
                --dart-define=API_BASE_URL=$(API_BASE_URL) \
                --dart-define=CLIENT_ID=$(CLIENT_ID) \
                --dart-define=REDIRECT_URI=$(REDIRECT_URI) \
                --dart-define=POST_LOGOUT_REDIRECT_URI=$(POST_LOGOUT_REDIRECT_URI) \
                --dart-define=SCOPES=$(SCOPES) \
                --dart-define=APP_NAME=$(APP_NAME)
              echo "✅ Production APK built successfully"
            displayName: 'Build Production APK'
            env:
              KEYSTORE_PASSWORD: $(KEYSTORE_PASSWORD)
              KEY_PASSWORD: $(KEY_PASSWORD)
              KEY_ALIAS: $(KEY_ALIAS)

          # Also build AAB for Play Store
          - script: |
              cd $(workingDirectory)
              echo "Building production AAB..."
              flutter build appbundle \
                --flavor production \
                -t lib/main_production.dart \
                --release \
                --dart-define=ENVIRONMENT=production \
                --dart-define=AUTH_AUTHORITY=$(AUTH_AUTHORITY) \
                --dart-define=API_BASE_URL=$(API_BASE_URL) \
                --dart-define=CLIENT_ID=$(CLIENT_ID) \
                --dart-define=REDIRECT_URI=$(REDIRECT_URI) \
                --dart-define=POST_LOGOUT_REDIRECT_URI=$(POST_LOGOUT_REDIRECT_URI) \
                --dart-define=SCOPES=$(SCOPES) \
                --dart-define=APP_NAME=$(APP_NAME)
              echo "✅ Production AAB built successfully"
            displayName: 'Build Production AAB'
            env:
              KEYSTORE_PASSWORD: $(KEYSTORE_PASSWORD)
              KEY_PASSWORD: $(KEY_PASSWORD)
              KEY_ALIAS: $(KEY_ALIAS)

          # Copy artifacts to staging directory
          - task: Bash@3
            displayName: 'Prepare Artifacts'
            inputs:
              targetType: 'inline'
              script: |
                cd $(workingDirectory)
                mkdir -p $(Build.ArtifactStagingDirectory)/android
                
                # Find and copy APK
                APK_PATH=$(find build/app/outputs/flutter-apk -name "*production*.apk" | head -1)
                if [ -n "$APK_PATH" ]; then
                  cp "$APK_PATH" $(Build.ArtifactStagingDirectory)/android/sigook-production-$(Build.BuildId).apk
                  echo "✅ APK copied"
                fi
                
                # Find and copy AAB
                AAB_PATH=$(find build/app/outputs/bundle -name "*.aab" | head -1)
                if [ -n "$AAB_PATH" ]; then
                  cp "$AAB_PATH" $(Build.ArtifactStagingDirectory)/android/sigook-production-$(Build.BuildId).aab
                  echo "✅ AAB copied"
                fi
                
                ls -la $(Build.ArtifactStagingDirectory)/android/

          # Publish artifacts
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Production Android Artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/android'
              ArtifactName: 'sigookapp-android-production'
              publishLocation: 'Container'

          - task: Bash@3
            displayName: 'Build Summary'
            inputs:
              targetType: 'inline'
              script: |
                echo ""
                echo "========================================"
                echo "✅ Production Android Build Complete!"
                echo "========================================"
                echo "Artifact: sigookapp-android-production"
                echo "APK: sigook-production-$(Build.BuildId).apk"
                echo "AAB: sigook-production-$(Build.BuildId).aab"
                echo "Build ID: $(Build.BuildId)"
                echo "========================================"

  # ============================================
  # iOS Build Stages - REMOVED
  # iOS signing not configured yet
  # Re-add these stages when iOS certificates and
  # provisioning profiles are set up in Azure DevOps
  # ============================================
