trigger:
  - main
  - master
  - dev
name: $(Year:yyyy).$(Month).$(DayOfMonth).$(Rev:r)
variables:
  isMain: $[in(variables['Build.SourceBranch'], 'refs/heads/main','refs/heads/master','main','master')]
  isDev: $[ in(variables['Build.SourceBranch'], 'refs/heads/dev', 'refs/heads/development', 'dev', 'development') ]

pool:
  vmImage: "ubuntu-22.04"

stages:
  - stage: Tests
    jobs:
      - job: Tests
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '6.0.400'
          - task: DotNetCoreCLI@2
            displayName: 'Build Solution'
            inputs:
              command: 'build'
              projects: '**/*.sln'
          - task: DotNetCoreCLI@2
            displayName: 'Running Unit Test'
            inputs:
              command: 'test'
              projects: '**/*(Covenant.Tests)/*.csproj'
              arguments: '--logger "console;verbosity=detailed" --no-build'
              testRunTitle: 'Running Unit Test'
              publishTestResults: true
          - task: DotNetCoreCLI@2
            displayName: 'Running Integration Test'
            inputs:
              command: 'test'
              projects: '**/*(Covenant.Integration.Tests)/*.csproj'
              arguments: '--logger "console;verbosity=detailed" --no-build'
              testRunTitle: 'Running Integration Test'
              publishTestResults: true

  - stage: PrepareNuGet
    dependsOn: Tests
    condition: and(succeeded(), eq(variables.isDev, true))
    jobs:
      - job: CheckNuGetChanges
        displayName: 'Check Changes in Covenant.Common'
        steps:
          - checkout: self
            fetchDepth: "0"
          - powershell: |
              $changes = git diff --name-only origin/master HEAD | Select-String -Pattern "Covenant.Common"
              $changes
              if ($changes) {
                Write-Host "##vso[task.setvariable variable=NugetChanges;isOutput=true]true"
              } else {
                Write-Host "##vso[task.setvariable variable=NugetChanges;isOutput=true]false"
              }
            name: CheckNuGetChanges

      - job: CreateNuGet
        displayName: 'Create and Publish NuGet Package'
        dependsOn: CheckNuGetChanges
        condition: eq(dependencies.CheckNuGetChanges.outputs['CheckNuGetChanges.NugetChanges'], 'true')
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '6.0.400'
          - task: DotNetCoreCLI@2
            displayName: "Pack Covenant.Common"
            inputs:
              command: pack
              versioningScheme: byBuildNumber
              packagesToPack: "**/Covenant.Common.csproj"

          - task: NuGetAuthenticate@1
            displayName: 'NuGet Authenticate'

          - task: NuGetCommand@2
            displayName: 'Push Covenant.Common to Feed'
            inputs:
              command: push
              publishVstsFeed: "sigook/Covenant.Common"
              allowPackageConflicts: true

  - stage: Publish
    dependsOn: 
      - Tests
    condition: and(succeeded(), or(eq(variables['isDev'], true), eq(variables['isMain'], true))) 
    jobs:
      - job: BuildPublish
        steps:
          - script: |
              echo "Calculating TAG based on branch $(Build.SourceBranchName)â€¦"
                if [ "$(isDev)" = True ]; then
                  tag=latest_staging
                else
                  tag=latest_production
                fi
                echo "##vso[task.setvariable variable=tag]$tag"
                echo "##vso[task.setvariable variable=tag;isOutput=true]$tag"
                echo "TAG calculated: $tag"
            name: SetTag
          - task: Docker@2
            displayName: 'Build and Push Docker Image'
            inputs:
              containerRegistry: 'acrServiceConnectionSigook'
              repository: 'api'
              command: 'buildAndPush'
              Dockerfile: 'Covenant.Api/Dockerfile'
              tags: $(tag)
      - job: DeployApplication
        displayName: 'Deploy Docker Image to Environment'
        dependsOn: BuildPublish
        variables:
          imageTag: $[ dependencies.BuildPublish.outputs['SetTag.tag'] ]
        steps:
          - script: |
              if [ "$(isDev)" = "True" ] || [ "$(isDev)" = "true" ]; then
                azureAppName="sigook-api-staging"
              else
                azureAppName="sigook-api"
              fi
              echo "##vso[task.setvariable variable=azureAppName]$azureAppName"
              echo "Target environment: $azureAppName"
              echo "Docker image tag: $(imageTag)"
            displayName: Determine Deployment Target
          - task: AzureWebAppContainer@1
            displayName: 'Deploy to Web App'
            inputs:
              azureSubscription: 'SigookPipelines'
              appName: $(azureAppName)
              containers: sigook.azurecr.io/api:$(imageTag)
              appSettings: '-CVN_VERSION $(Build.BuildId)'
